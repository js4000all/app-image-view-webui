## Context Handoff
- Goal: `app.py` の単一実装を FastAPI ベースのレイヤ構成へ分割し、既存 API 契約を維持したまま `uvicorn` 起動へ移行する。
- Changes:
  - `app/` パッケージを新設し、`api/` `services/` `repositories/` `models/` に責務を分離。
  - `app/services/image_service.py` に `ResourceRegistry` を実装し、`file_id` / `directory_id` 解決と Lock を一元化。
  - `app/api/routes.py` に既存互換 API (`/api/subdirectories`, `/api/images/{directory_id}`, `/api/image/{file_id}` ほか) を実装。
  - 静的ファイルパスを `AppSettings.static_dir` で設定化し、配信を `StaticFiles` に集約。
  - `app/main.py` で `uvicorn.run` を使う起動へ変更し、`app.py` は CLI 互換ラッパとして維持。
  - `requirements.txt` に `fastapi` と `uvicorn` を追加。
- Decisions:
  - Decision: ID レジストリのロック管理は `ResourceRegistry` のみが担当する。
  - Rationale: 競合制御の責務を 1 箇所に寄せ、API ハンドラから排他詳細を排除するため。
  - Impact: 将来の ID 解決仕様変更がサービス層だけで完結する。
  - Decision: 画像レスポンスの ETag / Last-Modified / 304 判定ロジックは API 層に維持する。
  - Rationale: HTTP 条件付きリクエストはトランスポート仕様に近く、ドメインロジックと分離しやすいため。
  - Impact: 既存キャッシュ挙動を保ったまま FastAPI 移行が可能。
- Open Questions:
  - FastAPI のバージョン更新時に `HEAD` の自動処理差分が出ないか、継続的な契約テストで監視が必要。
- Verification:
  - `python -m pip install -r requirements-dev.txt`
  - `pytest tests/api -q`
  - `python app.py tests/resources/image_root --host 127.0.0.1 --port 8001` + `curl` で API 応答確認
